<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:AI_Bible_App.Maui.ViewModels"
             xmlns:models="clr-namespace:AI_Bible_App.Core.Models;assembly=AI-Bible-App.Core"
             x:Class="AI_Bible_App.Maui.Views.UserSelectionPage"
             x:DataType="viewmodels:UserSelectionViewModel"
             x:Name="ThisPage"
             Title="Welcome"
             BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource OffBlack}}"
             Shell.NavBarIsVisible="False">

    <Grid RowDefinitions="Auto,*,Auto" Padding="20">
        
        <!-- Header -->
        <VerticalStackLayout Grid.Row="0" Spacing="10" Padding="0,40,0,20">
            <Label Text="ðŸ“–" 
                   FontSize="64" 
                   HorizontalOptions="Center"/>
            <Label Text="Voices of Scripture" 
                   FontSize="28" 
                   FontAttributes="Bold"
                   HorizontalOptions="Center"
                   TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"/>
            <Label Text="Select your profile to continue" 
                   FontSize="16" 
                   HorizontalOptions="Center"
                   TextColor="{AppThemeBinding Light=Gray, Dark=LightGray}"/>
        </VerticalStackLayout>
        
        <!-- User List -->
        <CollectionView Grid.Row="1" 
                        ItemsSource="{Binding Users}"
                        SelectionMode="None"
                        VerticalOptions="Center">
            <CollectionView.EmptyView>
                <VerticalStackLayout VerticalOptions="Center" Spacing="10">
                    <Label Text="No profiles yet" 
                           FontSize="18" 
                           HorizontalOptions="Center"
                           TextColor="Gray"/>
                    <Label Text="Create your first profile below" 
                           FontSize="14" 
                           HorizontalOptions="Center"
                           TextColor="Gray"/>
                </VerticalStackLayout>
            </CollectionView.EmptyView>
            
            <CollectionView.ItemsLayout>
                <LinearItemsLayout Orientation="Vertical" ItemSpacing="10"/>
            </CollectionView.ItemsLayout>
            
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:AppUser">
                    <Border Padding="15" 
                            StrokeShape="RoundRectangle 12"
                            Stroke="{AppThemeBinding Light=LightGray, Dark=DarkSlateGray}"
                            BackgroundColor="{AppThemeBinding Light=White, Dark='#2D2D2D'}">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer 
                                Command="{Binding Path=BindingContext.SelectUserCommand, Source={x:Reference ThisPage}}"
                                CommandParameter="{Binding}"/>
                        </Border.GestureRecognizers>
                        
                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="15">
                            <!-- Avatar -->
                            <Border Grid.Column="0" 
                                    WidthRequest="50" HeightRequest="50"
                                    StrokeShape="RoundRectangle 25"
                                    StrokeThickness="0"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray600}}">
                                <Image Source="default_avatar.png" 
                                       WidthRequest="35"
                                       HeightRequest="35"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"/>
                            </Border>
                            
                            <!-- Name and Details -->
                            <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="2">
                                <HorizontalStackLayout Spacing="8">
                                    <Label Text="{Binding Name}" 
                                           FontSize="18" 
                                           FontAttributes="Bold"/>
                                    <!-- Lock icon for PIN-protected users -->
                                    <Label Text="ðŸ”’" 
                                           FontSize="14"
                                           IsVisible="{Binding HasPin}"
                                           VerticalOptions="Center"/>
                                </HorizontalStackLayout>
                                <Label Text="{Binding LastActiveAt, StringFormat='Last active: {0:MMM d, yyyy}'}" 
                                       FontSize="12" 
                                       TextColor="Gray"/>
                            </VerticalStackLayout>
                            
                            <!-- Arrow -->
                            <Label Grid.Column="2" 
                                   Text="â†’" 
                                   FontSize="20" 
                                   VerticalOptions="Center"
                                   TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"/>
                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
        
        <!-- Create New User Section -->
        <VerticalStackLayout Grid.Row="2" Spacing="15" Padding="0,20,0,20">
            <BoxView HeightRequest="1" 
                     Color="{AppThemeBinding Light=LightGray, Dark=DarkSlateGray}"
                     Margin="0,0,0,10"/>
            
            <Label Text="Create New Profile" 
                   FontSize="16" 
                   FontAttributes="Bold"
                   HorizontalOptions="Center"/>
            
            <Frame Padding="10" CornerRadius="8" BorderColor="Transparent"
                   BackgroundColor="{AppThemeBinding Light='#F5F5F5', Dark='#1E1E1E'}">
                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                    <Entry Grid.Column="0"
                           Placeholder="Enter your name"
                           Text="{Binding NewUserName}"
                           ReturnCommand="{Binding CreateUserCommand}"
                           MaxLength="50"
                           FontSize="16"/>
                    <Button Grid.Column="1"
                            Text="Create"
                            Command="{Binding CreateUserCommand}"
                            BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                            TextColor="White"
                            CornerRadius="8"
                            Padding="20,10"/>
                </Grid>
            </Frame>
            
            <!-- Custom Avatar Entry -->
            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="15" HorizontalOptions="Center">
                <Frame Grid.Column="0" 
                       WidthRequest="60" HeightRequest="60"
                       CornerRadius="30" Padding="0"
                       BackgroundColor="{AppThemeBinding Light='#E8F5E9', Dark='#1B5E20'}">
                    <Label Text="{Binding SelectedEmoji}" 
                           FontSize="30"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"/>
                </Frame>
                
                <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="5">
                    <Label Text="Profile Avatar" FontSize="14" FontAttributes="Bold"/>
                    <Entry Text="{Binding SelectedEmoji}"
                           Placeholder="Enter emoji or initial"
                           FontSize="18"
                           MaxLength="2"
                           WidthRequest="150"
                           HorizontalOptions="Start"/>
                    <Label Text="Type any emoji or letter" FontSize="11" TextColor="Gray"/>
                </VerticalStackLayout>
            </Grid>
        </VerticalStackLayout>
        
        <!-- Loading Overlay -->
        <Grid Grid.RowSpan="3" 
              IsVisible="{Binding IsBusy}"
              BackgroundColor="{AppThemeBinding Light='#80FFFFFF', Dark='#80000000'}">
            <ActivityIndicator IsRunning="{Binding IsBusy}" 
                               HorizontalOptions="Center" 
                               VerticalOptions="Center"
                               Color="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"/>
        </Grid>
        
        <!-- PIN Entry Overlay -->
        <Grid Grid.RowSpan="3" 
              IsVisible="{Binding IsPinEntryVisible}"
              BackgroundColor="{AppThemeBinding Light='#E0FFFFFF', Dark='#E0000000'}">
            <Frame HorizontalOptions="Center" 
                   VerticalOptions="Center"
                   Padding="30"
                   CornerRadius="16"
                   BackgroundColor="{AppThemeBinding Light=White, Dark='#2D2D2D'}"
                   HasShadow="True"
                   WidthRequest="320">
                <VerticalStackLayout Spacing="20">
                    <!-- User Avatar and Name -->
                    <VerticalStackLayout Spacing="10" HorizontalOptions="Center">
                        <Frame WidthRequest="70" HeightRequest="70"
                               CornerRadius="35" Padding="0"
                               HorizontalOptions="Center"
                               BackgroundColor="{AppThemeBinding Light='#E8F5E9', Dark='#1B5E20'}">
                            <Label Text="{Binding PendingUser.AvatarEmoji}" 
                                   FontSize="36"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center"/>
                        </Frame>
                        <Label Text="{Binding PendingUser.Name}" 
                               FontSize="20" 
                               FontAttributes="Bold"
                               HorizontalOptions="Center"/>
                        <Label Text="Enter your PIN" 
                               FontSize="14" 
                               TextColor="Gray"
                               HorizontalOptions="Center"/>
                    </VerticalStackLayout>
                    
                    <!-- PIN Entry -->
                    <Entry Placeholder="PIN"
                           Text="{Binding PinEntry}"
                           Keyboard="Numeric"
                           IsPassword="True"
                           MaxLength="6"
                           FontSize="24"
                           HorizontalTextAlignment="Center"
                           ReturnCommand="{Binding SubmitPinCommand}"/>
                    
                    <!-- Error Message -->
                    <Label Text="{Binding PinError}"
                           TextColor="Red"
                           FontSize="12"
                           HorizontalOptions="Center"
                           IsVisible="{Binding PinError, Converter={StaticResource StringNotEmptyConverter}}"/>
                    
                    <!-- Buttons -->
                    <HorizontalStackLayout Spacing="15" HorizontalOptions="Center">
                        <Button Text="Cancel"
                                Command="{Binding CancelPinEntryCommand}"
                                BackgroundColor="Gray"
                                TextColor="White"
                                CornerRadius="8"
                                WidthRequest="100"/>
                        <Button Text="Enter"
                                Command="{Binding SubmitPinCommand}"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                TextColor="White"
                                CornerRadius="8"
                                WidthRequest="100"/>
                    </HorizontalStackLayout>
                </VerticalStackLayout>
            </Frame>
        </Grid>
    </Grid>
</ContentPage>
