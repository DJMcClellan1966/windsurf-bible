<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:AI_Bible_App.Maui.ViewModels"
             x:Class="AI_Bible_App.Maui.Views.BibleReaderPage"
             x:DataType="vm:BibleReaderViewModel"
             Title="{Binding Title}">

    <!-- Hallow gradient background -->
    <ContentPage.Background>
        <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
            <GradientStop Color="{StaticResource HallowDarkPurple}" Offset="0.0" />
            <GradientStop Color="{StaticResource HallowDeepBlue}" Offset="0.5" />
            <GradientStop Color="{StaticResource HallowMidPurple}" Offset="1.0" />
        </LinearGradientBrush>
    </ContentPage.Background>
    
    <Grid RowDefinitions="Auto,Auto,Auto,*,Auto" Padding="15">
        
        <!-- Header with Back Button -->
        <Frame Grid.Row="0" Margin="0,5,0,15" Padding="12"
               BackgroundColor="{StaticResource HallowCardBackground}"
               BorderColor="Transparent"
               CornerRadius="20">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <Button Grid.Column="0"
                        Text="â—€ Back"
                        Command="{Binding GoBackCommand}"
                        BackgroundColor="Transparent"
                        TextColor="{StaticResource HallowAccentPurple}"
                        FontSize="14"
                        HeightRequest="36"/>
                <Label Grid.Column="1"
                       Text="ðŸ“– Bible Reader"
                       FontSize="20"
                       FontAttributes="Bold"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       TextColor="{StaticResource HallowTextPrimary}"/>
                <Button Grid.Column="2"
                        Text="ðŸ”–"
                        Command="{Binding ToggleBookmarksCommand}"
                        BackgroundColor="Transparent"
                        TextColor="{StaticResource HallowTextSecondary}"
                        FontSize="20"
                        HeightRequest="36"/>
            </Grid>
        </Frame>
        
        <!-- Search Bar -->
        <Frame Grid.Row="1" 
               Padding="12,8"
               Margin="0,0,0,10"
               BackgroundColor="{StaticResource HallowCardBackground}"
               BorderColor="Transparent"
               CornerRadius="25">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <Label Grid.Column="0"
                       Text="ðŸ”"
                       FontSize="18"
                       VerticalOptions="Center"
                       Margin="0,0,10,0"/>
                <Entry Grid.Column="1"
                       Text="{Binding SearchQuery}"
                       Placeholder="Search verses (e.g., 'love', 'John 3:16')"
                       PlaceholderColor="{StaticResource HallowTextMuted}"
                       TextColor="{StaticResource HallowTextPrimary}"
                       ReturnCommand="{Binding SearchCommand}"
                       FontSize="14"/>
                <Button Grid.Column="2"
                        Text="Search"
                        Command="{Binding SearchCommand}"
                        BackgroundColor="{StaticResource HallowAccentPurple}"
                        TextColor="{StaticResource HallowTextPrimary}"
                        FontSize="12"
                        HeightRequest="36"
                        CornerRadius="18"
                        Padding="15,0"/>
            </Grid>
        </Frame>
        
        <!-- Book/Chapter Picker -->
        <Grid Grid.Row="2" ColumnDefinitions="2*,*,Auto" ColumnSpacing="10" Margin="0,0,0,10">
            <Frame Grid.Column="0"
                   Padding="5"
                   BackgroundColor="{StaticResource HallowCardBackground}"
                   BorderColor="Transparent"
                   CornerRadius="12">
                <Picker ItemsSource="{Binding Books}"
                        SelectedItem="{Binding SelectedBook}"
                        Title="Select Book"
                        TitleColor="{StaticResource HallowTextMuted}"
                        TextColor="{StaticResource HallowTextPrimary}"
                        FontSize="14"/>
            </Frame>
            
            <Frame Grid.Column="1"
                   Padding="5"
                   BackgroundColor="{StaticResource HallowCardBackground}"
                   BorderColor="Transparent"
                   CornerRadius="12">
                <Picker ItemsSource="{Binding Chapters}"
                        SelectedItem="{Binding SelectedChapter}"
                        Title="Chapter"
                        TitleColor="{StaticResource HallowTextMuted}"
                        TextColor="{StaticResource HallowTextPrimary}"
                        FontSize="14"/>
            </Frame>
            
            <Button Grid.Column="2"
                    Text="Go"
                    Command="{Binding LoadChapterCommand}"
                    HeightRequest="44"
                    WidthRequest="55"
                    CornerRadius="12"
                    TextColor="{StaticResource HallowTextPrimary}">
                <Button.Background>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                        <GradientStop Color="{StaticResource HallowAccentPurple}" Offset="0.0" />
                        <GradientStop Color="{StaticResource HallowRose}" Offset="1.0" />
                    </LinearGradientBrush>
                </Button.Background>
            </Button>
        </Grid>
        
        <!-- Search Results / Verse Display -->
        <Grid Grid.Row="3">
            <!-- Search Results Panel (overlays when searching) -->
            <Border x:Name="SearchResultsPanel"
                   IsVisible="{Binding IsSearching}"
                   BackgroundColor="{StaticResource HallowCardBackground}"
                   Stroke="Transparent"
                   StrokeShape="RoundRectangle 15"
                   Padding="15"
                   ZIndex="10">
                <Grid RowDefinitions="Auto,*">
                    <HorizontalStackLayout Grid.Row="0" Spacing="10" Margin="0,0,0,10">
                        <Label Text="{Binding SearchResultCount, StringFormat='ðŸ“œ {0} results found'}"
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="{StaticResource HallowAccentPurple}"/>
                        <Button Text="âœ• Close"
                                Command="{Binding ClearSearchCommand}"
                                BackgroundColor="Transparent"
                                TextColor="{StaticResource HallowTextSecondary}"
                                FontSize="12"
                                HeightRequest="30"/>
                    </HorizontalStackLayout>
                    
                    <CollectionView Grid.Row="1"
                                    ItemsSource="{Binding SearchResults}"
                                    SelectionMode="Single"
                                    SelectionChanged="OnSearchResultSelected">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <SwipeView>
                                    <SwipeView.RightItems>
                                        <SwipeItems Mode="Execute">
                                            <SwipeItem Text="ðŸ”– Bookmark"
                                                       BackgroundColor="{StaticResource HallowAccentPurple}"
                                                       Invoked="OnBookmarkSwipe"/>
                                        </SwipeItems>
                                    </SwipeView.RightItems>
                                    <Frame Padding="12"
                                           Margin="0,5"
                                           BackgroundColor="{StaticResource HallowCardHover}"
                                           BorderColor="Transparent"
                                           CornerRadius="12">
                                        <VerticalStackLayout Spacing="5">
                                            <Label Text="{Binding Reference}"
                                                   FontSize="14"
                                                   FontAttributes="Bold"
                                                   TextColor="{StaticResource HallowAccentPurple}"/>
                                            <Label Text="{Binding Text}"
                                                   FontSize="13"
                                                   TextColor="{StaticResource HallowTextPrimary}"
                                                   LineBreakMode="WordWrap"
                                                   MaxLines="3"/>
                                        </VerticalStackLayout>
                                    </Frame>
                                </SwipeView>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </Grid>
            </Border>
            
            <!-- Main Verse Reader -->
            <Frame IsVisible="{Binding IsSearching, Converter={StaticResource InvertedBoolConverter}}"
                   BackgroundColor="{StaticResource HallowCardBackground}"
                   BorderColor="Transparent"
                   CornerRadius="15"
                   Padding="0">
                <ScrollView x:Name="VerseScrollView">
                    <VerticalStackLayout Padding="15" Spacing="0">
                        <!-- Chapter Heading -->
                        <Label Text="{Binding CurrentChapterHeading}"
                               FontSize="24"
                               FontAttributes="Bold"
                               HorizontalOptions="Center"
                               TextColor="{StaticResource HallowTextPrimary}"
                               Margin="0,10,0,15"/>
                        
                        <!-- Decorative Divider -->
                        <Frame WidthRequest="200" HeightRequest="3"
                               BackgroundColor="{StaticResource HallowAccentPurple}"
                               BorderColor="Transparent"
                               CornerRadius="2"
                               HorizontalOptions="Center"
                               Margin="0,0,0,20"
                               Opacity="0.5"/>
                        
                        <!-- Verses -->
                        <CollectionView ItemsSource="{Binding CurrentVerses}"
                                        SelectionMode="Single"
                                        SelectionChanged="OnVerseSelected">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid ColumnDefinitions="35,*" Margin="0,8" Padding="5">
                                        <Frame Grid.Column="0"
                                               BackgroundColor="{StaticResource HallowAccentPurple}"
                                               CornerRadius="10"
                                               Padding="0"
                                               WidthRequest="28"
                                               HeightRequest="22"
                                               VerticalOptions="Start"
                                               Margin="0,4,0,0">
                                            <Label Text="{Binding Verse}"
                                                   FontSize="11"
                                                   FontAttributes="Bold"
                                                   TextColor="{StaticResource HallowTextPrimary}"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center"/>
                                        </Frame>
                                        <Label Grid.Column="1"
                                               Text="{Binding Text}"
                                               FontSize="16"
                                               LineHeight="1.6"
                                               TextColor="{StaticResource HallowTextPrimary}"
                                               LineBreakMode="WordWrap"/>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                        
                        <!-- End Decorative -->
                        <Label Text="âœ¦"
                               FontSize="16"
                               TextColor="{StaticResource HallowAccentPurple}"
                               HorizontalOptions="Center"
                               Margin="0,20"
                               Opacity="0.6"/>
                    </VerticalStackLayout>
                </ScrollView>
            </Frame>
            
            <!-- Loading Indicator -->
            <ActivityIndicator IsRunning="{Binding IsBusy}"
                               IsVisible="{Binding IsBusy}"
                               Color="{StaticResource HallowAccentPurple}"
                               WidthRequest="40"
                               HeightRequest="40"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"/>
        </Grid>
        
        <!-- Navigation Footer -->
        <Frame Grid.Row="4" Margin="0,10,0,0" Padding="10"
               BackgroundColor="{StaticResource HallowCardBackground}"
               BorderColor="Transparent"
               CornerRadius="20">
            <Grid ColumnDefinitions="*,Auto,*">
                <Button Grid.Column="0"
                        Text="â—€ Previous"
                        Command="{Binding PreviousChapterCommand}"
                        BackgroundColor="{StaticResource HallowCardHover}"
                        TextColor="{StaticResource HallowTextPrimary}"
                        FontSize="13"
                        HeightRequest="44"
                        CornerRadius="22"/>
                
                <VerticalStackLayout Grid.Column="1" HorizontalOptions="Center" Spacing="3">
                    <Label Text="{Binding SelectedBook}"
                           FontSize="11"
                           TextColor="{StaticResource HallowTextMuted}"
                           HorizontalOptions="Center"/>
                    <HorizontalStackLayout Spacing="5">
                        <Button Text="ðŸ”Š"
                                Command="{Binding ReadAloudCommand}"
                                BackgroundColor="{StaticResource HallowCardHover}"
                                TextColor="{StaticResource HallowTextPrimary}"
                                FontSize="18"
                                HeightRequest="38"
                                WidthRequest="38"
                                CornerRadius="19"
                                Padding="0"/>
                        <Button Text="ðŸ“‹"
                                Command="{Binding CopyChapterCommand}"
                                BackgroundColor="{StaticResource HallowCardHover}"
                                TextColor="{StaticResource HallowTextPrimary}"
                                FontSize="18"
                                HeightRequest="38"
                                WidthRequest="38"
                                CornerRadius="19"
                                Padding="0"/>
                        <Button Text="ðŸ’¬"
                                Command="{Binding DiscussWithCharacterCommand}"
                                BackgroundColor="{StaticResource HallowAccentPurple}"
                                TextColor="{StaticResource HallowTextPrimary}"
                                FontSize="18"
                                HeightRequest="38"
                                WidthRequest="38"
                                CornerRadius="19"
                                Padding="0"/>
                    </HorizontalStackLayout>
                </VerticalStackLayout>
                
                <Button Grid.Column="2"
                        Text="Next â–¶"
                        Command="{Binding NextChapterCommand}"
                        BackgroundColor="{StaticResource HallowCardHover}"
                        TextColor="{StaticResource HallowTextPrimary}"
                        FontSize="13"
                        HeightRequest="44"
                        CornerRadius="22"/>
            </Grid>
        </Frame>
    </Grid>
</ContentPage>
