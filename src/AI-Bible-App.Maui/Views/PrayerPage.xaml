<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:AI_Bible_App.Maui.ViewModels"
             xmlns:models="clr-namespace:AI_Bible_App.Core.Models;assembly=AI-Bible-App.Core"
             xmlns:controls="clr-namespace:AI_Bible_App.Maui.Controls"
             x:Class="AI_Bible_App.Maui.Views.PrayerPage"
             x:DataType="vm:PrayerViewModel"
             Title="{Binding Title}"
             BackgroundColor="{DynamicResource PageBackgroundColor}">
    
    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">
            
            <!-- Header -->
            <Label Text="ðŸ™ Prayer Generator"
                   FontSize="32"
                   FontAttributes="Bold"
                   HorizontalOptions="Center"
                   TextColor="{DynamicResource Primary}"/>
            
            <Label Text="Share your prayer request and receive a personalized prayer"
                   FontSize="14"
                   HorizontalOptions="Center"
                   TextColor="{DynamicResource Gray600}"
                   Margin="0,0,0,20"/>

            <!-- Prayer Request Input -->
            <Border Padding="15"
                    StrokeThickness="1"
                    Stroke="{DynamicResource Gray300}"
                    BackgroundColor="{AppThemeBinding Light={StaticResource InputBackground}, Dark={StaticResource InputBackgroundDark}}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="12"/>
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="10">
                    <Label Text="Your Prayer Request:"
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light={StaticResource TextColor}, Dark={StaticResource TextColorDark}}"/>
                    <Editor Text="{Binding PrayerRequest}"
                            Placeholder="What would you like to pray about?"
                            PlaceholderColor="{DynamicResource Gray400}"
                            TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                            MaxLength="1000"
                            HeightRequest="120"
                            AutoSize="TextChanges"/>
                </VerticalStackLayout>
            </Border>

            <!-- Generate Button -->
            <Button Text="Generate Prayer"
                    Command="{Binding GeneratePrayerCommand}"
                    IsEnabled="{Binding IsGenerating, Converter={StaticResource InvertedBoolConverter}}"
                    HeightRequest="50"
                    FontSize="18"
                    BackgroundColor="{DynamicResource Primary}"
                    TextColor="White"
                    CornerRadius="12"/>

            <!-- Loading Indicator -->
            <ActivityIndicator IsRunning="{Binding IsGenerating}"
                             IsVisible="{Binding IsGenerating}"
                             Color="{DynamicResource Primary}"
                             WidthRequest="40"
                             HeightRequest="40"
                             HorizontalOptions="Center"/>

            <!-- Generated Prayer -->
            <Border IsVisible="{Binding GeneratedPrayer, Converter={StaticResource StringNotEmptyConverter}}"
                    Padding="20"
                    StrokeThickness="2"
                    Stroke="{DynamicResource Primary}"
                    BackgroundColor="{AppThemeBinding Light={StaticResource CardBackground}, Dark={StaticResource CardBackgroundDark}}"
                    Shadow="{Shadow Brush=Black, Offset='0,2', Radius=4, Opacity=0.3}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="12"/>
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="15">
                    <Label Text="Your Prayer:"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource Primary}"/>
                    <controls:BibleLinkLabel LinkedText="{Binding GeneratedPrayer}"
                           FontSize="14"
                           LineBreakMode="WordWrap"
                           TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"/>
                    
                    <!-- Action Buttons -->
                    <Grid ColumnDefinitions="*,*,*" ColumnSpacing="10" Margin="0,10,0,0">
                        <Button Grid.Column="0"
                                Text="Save"
                                Command="{Binding SavePrayerCommand}"
                                BackgroundColor="{DynamicResource Success}"
                                TextColor="White"
                                CornerRadius="8"/>
                        <Button Grid.Column="1"
                                Text="ðŸ“ Reflect"
                                Command="{Binding SaveToReflectionsCommand}"
                                BackgroundColor="{DynamicResource Primary}"
                                TextColor="White"
                                CornerRadius="8"/>
                        <Button Grid.Column="2"
                                Text="New"
                                Command="{Binding NewPrayerCommand}"
                                BackgroundColor="{DynamicResource Secondary}"
                                TextColor="White"
                                CornerRadius="8"/>
                    </Grid>
                </VerticalStackLayout>
            </Border>

            <!-- Saved Prayers Section -->
            <VerticalStackLayout Spacing="10" Margin="0,20,0,0">
                <Label Text="ðŸ’¾ Saved Prayers"
                       FontSize="20"
                       FontAttributes="Bold"/>
                
                <CollectionView ItemsSource="{Binding SavedPrayers}"
                               SelectionMode="Single"
                               SelectedItem="{Binding SelectedPrayer}">
                    <CollectionView.EmptyView>
                        <Label Text="No saved prayers yet"
                               FontSize="14"
                               TextColor="{DynamicResource Gray600}"
                               HorizontalOptions="Center"
                               Margin="0,20"/>
                    </CollectionView.EmptyView>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Prayer">
                            <Border Padding="15"
                                    Margin="0,0,0,10"
                                    StrokeThickness="1"
                                    Stroke="{DynamicResource Gray300}"
                                    BackgroundColor="{DynamicResource CardBackground}">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="8"/>
                                </Border.StrokeShape>
                                <VerticalStackLayout Spacing="5">
                                    <Label Text="{Binding Topic}"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                                           LineBreakMode="TailTruncation"
                                           MaxLines="2"/>
                                    <Label Text="{Binding CreatedAt, Converter={StaticResource UtcToLocalTimeConverter}, StringFormat='{0:MMMM d, yyyy h:mm tt}'}"
                                           FontSize="12"
                                           TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"/>
                                </VerticalStackLayout>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
