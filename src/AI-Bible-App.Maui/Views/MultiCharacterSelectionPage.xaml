<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:AI_Bible_App.Maui.ViewModels"
             xmlns:models="clr-namespace:AI_Bible_App.Core.Models;assembly=AI-Bible-App.Core"
             x:Class="AI_Bible_App.Maui.Views.MultiCharacterSelectionPage"
             x:DataType="vm:MultiCharacterSelectionViewModel"
             Title="{Binding Title}"
             BackgroundColor="{DynamicResource PageBackgroundColor}">
    
    <Grid RowDefinitions="Auto,Auto,*,Auto" Padding="15">
        
        <!-- Header -->
        <VerticalStackLayout Grid.Row="0" Spacing="6" Margin="0,10,0,10">
            <Label Text="ðŸ‘¥ Multi-Character Chat"
                   FontSize="26"
                   FontAttributes="Bold"
                   HorizontalOptions="Center"
                   TextColor="{DynamicResource Primary}"/>
            <Label Text="{Binding ModeDescription}"
                   FontSize="14"
                   HorizontalOptions="Center"
                   TextColor="{DynamicResource Gray600}"
                   LineBreakMode="WordWrap"
                   HorizontalTextAlignment="Center"
                   Margin="0,0,0,5"/>
        </VerticalStackLayout>

        <!-- Mode Selection -->
        <Border Grid.Row="1"
                Padding="12"
                Margin="0,0,0,12"
                BackgroundColor="{DynamicResource CardBackground}"
                StrokeThickness="1"
                Stroke="{DynamicResource Gray300}">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="10"/>
            </Border.StrokeShape>
            
            <VerticalStackLayout Spacing="8">
                <Label Text="Select Mode:"
                       FontSize="14"
                       FontAttributes="Bold"
                       Margin="0,0,0,3"/>
                
                <FlexLayout Wrap="Wrap" 
                            JustifyContent="Center" 
                            AlignItems="Center">
                    <Button Text="ðŸŽ¯ Roundtable"
                            Command="{Binding SetModeCommand}"
                            CommandParameter="Roundtable"
                            BackgroundColor="{Binding RoundtableButtonColor}"
                            TextColor="White"
                            CornerRadius="8"
                            Padding="10,6"
                            FontSize="13"
                            Margin="4"/>
                    
                    <Button Text="ðŸ§  Wisdom Council"
                            Command="{Binding SetModeCommand}"
                            CommandParameter="WisdomCouncil"
                            BackgroundColor="{Binding WisdomCouncilButtonColor}"
                            TextColor="White"
                            CornerRadius="8"
                            Padding="10,6"
                            FontSize="13"
                            Margin="4"/>
                    
                    <Button Text="ðŸ™ Prayer Chain"
                            Command="{Binding SetModeCommand}"
                            CommandParameter="PrayerChain"
                            BackgroundColor="{Binding PrayerChainButtonColor}"
                            TextColor="White"
                            CornerRadius="8"
                            Padding="10,6"
                            FontSize="13"
                            Margin="4"/>
                </FlexLayout>
            </VerticalStackLayout>
        </Border>

        <!-- Character List with Multi-Select -->
        <ScrollView Grid.Row="2">
            <VerticalStackLayout Spacing="10">
                <Label Text="{Binding SelectionInstruction}"
                       FontSize="14"
                       FontAttributes="Bold"
                       Margin="0,0,0,5"/>
                
                <Label Text="{Binding SelectedCountText}"
                       FontSize="13"
                       TextColor="{DynamicResource Primary}"
                       IsVisible="{Binding HasSelectedCharacters}"
                       Margin="0,0,0,3"/>
                
                <CollectionView ItemsSource="{Binding Characters}"
                                SelectionMode="None">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="vm:SelectableCharacter">
                            <Grid Padding="0,0,0,8">
                                <!-- Clickable button overlay -->
                                <Button Clicked="OnCharacterTapped"
                                        BackgroundColor="Transparent"
                                        BorderWidth="0"
                                        HorizontalOptions="Fill"
                                        VerticalOptions="Fill"
                                        ZIndex="100"/>
                                
                                <Border Padding="10"
                                        BackgroundColor="{DynamicResource CardBackground}"
                                        InputTransparent="True"
                                        Shadow="{Shadow Brush=Black, Offset='0,2', Radius=4, Opacity=0.3}">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="10"/>
                                    </Border.StrokeShape>
                                
                                    <Grid ColumnDefinitions="Auto,55,*" ColumnSpacing="10" InputTransparent="True">
                                        <!-- Selection Indicator -->
                                        <Border Grid.Column="0"
                                                WidthRequest="28"
                                                HeightRequest="28"
                                                VerticalOptions="Center"
                                                InputTransparent="True"
                                                BackgroundColor="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#512BD4,#E0E0E0'}"
                                                Stroke="{DynamicResource Primary}"
                                                StrokeThickness="2">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="6"/>
                                            </Border.StrokeShape>
                                            <Label Text="âœ“"
                                                   FontSize="18"
                                                   FontAttributes="Bold"
                                                   TextColor="White"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center"
                                                   InputTransparent="True"
                                                   Opacity="{Binding IsSelected, Converter={StaticResource BoolToDoubleConverter}}"/>
                                        </Border>
                                    
                                        <!-- Avatar Circle -->
                                        <Border Grid.Column="1"
                                                WidthRequest="50"
                                                HeightRequest="50"
                                                Padding="0"
                                                InputTransparent="True"
                                                BackgroundColor="{DynamicResource Primary}">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="25"/>
                                            </Border.StrokeShape>
                                            <Label Text="{Binding Character.Name, Converter={StaticResource FirstLetterConverter}}"
                                                   FontSize="24"
                                                   FontAttributes="Bold"
                                                   TextColor="White"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center"
                                                   InputTransparent="True"/>
                                        </Border>
                                    
                                        <!-- Character Info -->
                                        <VerticalStackLayout Grid.Column="2" Spacing="2" VerticalOptions="Center" InputTransparent="True">
                                            <Label Text="{Binding Character.Name}"
                                                   FontSize="15"
                                                   FontAttributes="Bold"
                                                   InputTransparent="True"
                                                   LineBreakMode="TailTruncation"/>
                                            <Label Text="{Binding Character.Title}"
                                                   FontSize="12"
                                                   TextColor="{DynamicResource Primary}"
                                                   InputTransparent="True"
                                                   LineBreakMode="TailTruncation"/>
                                            <Label Text="{Binding Character.Description}"
                                                   FontSize="10"
                                                   TextColor="{DynamicResource Gray600}"
                                                   LineBreakMode="WordWrap"
                                                   InputTransparent="True"
                                                   MaxLines="2"/>
                                        </VerticalStackLayout>
                                    </Grid>
                                </Border>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>
        </ScrollView>

        <!-- Start Button -->
        <Button Grid.Row="3"
                Text="{Binding StartButtonText}"
                Command="{Binding StartMultiCharacterChatCommand}"
                IsEnabled="{Binding CanStartChat}"
                Margin="0,12,0,0"
                HeightRequest="48"
                FontSize="16"
                BackgroundColor="{DynamicResource Primary}"
                TextColor="White"
                CornerRadius="10"/>
        
        <!-- Loading Indicator with text -->
        <Border Grid.RowSpan="4"
                IsVisible="{Binding IsBusy}"
                BackgroundColor="#80000000"
                HorizontalOptions="Fill"
                VerticalOptions="Fill">
            <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Spacing="15">
                <ActivityIndicator IsRunning="{Binding IsBusy}"
                                  Color="{DynamicResource Primary}"
                                  WidthRequest="60"
                                  HeightRequest="60"/>
                <Label Text="Loading characters..."
                       FontSize="16"
                       TextColor="White"
                       HorizontalOptions="Center"/>
            </VerticalStackLayout>
        </Border>
        
        <!-- Empty state message -->
        <Label Grid.Row="2"
               Text="No characters found. Please try again."
               IsVisible="{Binding HasNoCharacters}"
               FontSize="16"
               TextColor="{DynamicResource Gray600}"
               HorizontalOptions="Center"
               VerticalOptions="Center"/>
    </Grid>
</ContentPage>
