<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:AI_Bible_App.Maui.ViewModels"
             x:Class="AI_Bible_App.Maui.Views.ChatHistoryPage"
             x:DataType="vm:ChatHistoryViewModel"
             x:Name="ThisPage"
             Title="{Binding Title}">

    <!-- Hallow gradient background -->
    <ContentPage.Background>
        <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
            <GradientStop Color="{StaticResource HallowDarkPurple}" Offset="0.0" />
            <GradientStop Color="{StaticResource HallowDeepBlue}" Offset="0.5" />
            <GradientStop Color="{StaticResource HallowMidPurple}" Offset="1.0" />
        </LinearGradientBrush>
    </ContentPage.Background>

    <Grid RowDefinitions="Auto,Auto,*">
        
        <!-- Header Card -->
        <Frame Grid.Row="0" Margin="15,15,15,10" Padding="20"
               BackgroundColor="{StaticResource HallowCardBackground}"
               BorderColor="Transparent"
               CornerRadius="20"
               HasShadow="True">
            <VerticalStackLayout Spacing="8">
                <Label Text="ðŸ“œ Chat History"
                       FontSize="26"
                       FontAttributes="Bold"
                       HorizontalOptions="Center"
                       TextColor="{StaticResource HallowTextPrimary}"/>
                <BoxView HeightRequest="3" WidthRequest="60" CornerRadius="1.5"
                         HorizontalOptions="Center" Margin="0,5,0,5">
                    <BoxView.Background>
                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                            <GradientStop Color="{StaticResource HallowAccentPurple}" Offset="0.0" />
                            <GradientStop Color="{StaticResource HallowRose}" Offset="1.0" />
                        </LinearGradientBrush>
                    </BoxView.Background>
                </BoxView>
                <Label Text="Resume or review past conversations"
                       FontSize="14"
                       TextColor="{StaticResource HallowTextSecondary}"
                       HorizontalOptions="Center"/>
            </VerticalStackLayout>
        </Frame>

        <!-- Search Bar -->
        <Frame Grid.Row="1" Margin="15,0,15,10" Padding="0"
               BackgroundColor="{StaticResource HallowCardBackground}"
               BorderColor="Transparent"
               CornerRadius="25">
            <SearchBar Placeholder="Search conversations..."
                      Text="{Binding SearchText}"
                      BackgroundColor="Transparent"
                      TextColor="{StaticResource HallowTextPrimary}"
                      PlaceholderColor="{StaticResource HallowTextMuted}"/>
        </Frame>

        <!-- Loading Indicator -->
        <ActivityIndicator Grid.Row="2"
                          IsRunning="{Binding IsLoading}"
                          IsVisible="{Binding IsLoading}"
                          VerticalOptions="Center"
                          HorizontalOptions="Center"
                          HeightRequest="50"
                          WidthRequest="50"
                          Color="{StaticResource HallowAccentPurple}"/>

        <!-- Empty State -->
        <VerticalStackLayout Grid.Row="2"
                            IsVisible="{Binding IsEmpty}"
                            VerticalOptions="Center"
                            HorizontalOptions="Center"
                            Spacing="15">
            <Label Text="ðŸ’¬"
                   FontSize="60"
                   HorizontalOptions="Center"/>
            <Label Text="No conversations yet"
                   FontSize="20"
                   FontAttributes="Bold"
                   TextColor="{StaticResource HallowTextPrimary}"
                   HorizontalOptions="Center"/>
            <Label Text="Start chatting with a biblical character to see your history here"
                   FontSize="14"
                   TextColor="{StaticResource HallowTextSecondary}"
                   HorizontalOptions="Center"
                   HorizontalTextAlignment="Center"
                   MaximumWidthRequest="280"/>
            <Button Text="Start a Conversation"
                    Command="{Binding GoToCharactersCommand}"
                    TextColor="{StaticResource HallowTextPrimary}"
                    FontAttributes="Bold"
                    CornerRadius="25"
                    HeightRequest="50"
                    WidthRequest="220"
                    Margin="0,10,0,0">
                <Button.Background>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                        <GradientStop Color="{StaticResource HallowAccentPurple}" Offset="0.0" />
                        <GradientStop Color="{StaticResource HallowRose}" Offset="1.0" />
                    </LinearGradientBrush>
                </Button.Background>
            </Button>
        </VerticalStackLayout>

        <!-- Chat Sessions List -->
        <CollectionView Grid.Row="2"
                       ItemsSource="{Binding ChatSessions}"
                       IsVisible="{Binding IsEmpty, Converter={StaticResource InvertedBoolConverter}}"
                       SelectionMode="Single"
                       SelectedItem="{Binding SelectedSession}"
                       Margin="15">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="vm:ChatHistoryItem">
                    <SwipeView>
                        <SwipeView.LeftItems>
                            <SwipeItems>
                                <SwipeItem Text="Share"
                                          IconImageSource="share"
                                          BackgroundColor="{StaticResource HallowMidPurple}"
                                          Command="{Binding Path=BindingContext.ShareSessionCommand, Source={x:Reference ThisPage}}"
                                          CommandParameter="{Binding}"/>
                                <SwipeItem Text="Export"
                                          BackgroundColor="{StaticResource HallowAccentPurple}"
                                          Command="{Binding Path=BindingContext.ExportSessionCommand, Source={x:Reference ThisPage}}"
                                          CommandParameter="{Binding}"/>
                            </SwipeItems>
                        </SwipeView.LeftItems>
                        <SwipeView.RightItems>
                            <SwipeItems>
                                <SwipeItem Text="Delete"
                                          BackgroundColor="{StaticResource HallowRose}"
                                          Command="{Binding Path=BindingContext.DeleteSessionCommand, Source={x:Reference ThisPage}}"
                                          CommandParameter="{Binding}"/>
                            </SwipeItems>
                        </SwipeView.RightItems>
                        
                        <Frame Padding="15" Margin="0,0,0,10"
                               BackgroundColor="{StaticResource HallowCardBackground}"
                               BorderColor="Transparent"
                               CornerRadius="15">
                            
                            <Grid ColumnDefinitions="65,*,Auto" ColumnSpacing="15">
                                <!-- Character Avatar -->
                                <Frame Grid.Column="0"
                                       WidthRequest="65" HeightRequest="65"
                                       CornerRadius="32" Padding="0"
                                       BorderColor="Transparent">
                                    <Frame.Background>
                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                            <GradientStop Color="{StaticResource HallowAccentPurple}" Offset="0.0" />
                                            <GradientStop Color="{StaticResource HallowRose}" Offset="1.0" />
                                        </LinearGradientBrush>
                                    </Frame.Background>
                                    <Label Text="{Binding CharacterName, Converter={StaticResource FirstLetterConverter}}"
                                           FontSize="28"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource HallowTextPrimary}"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"/>
                                </Frame>
                                
                                <!-- Session Info -->
                                <VerticalStackLayout Grid.Column="1" Spacing="4" VerticalOptions="Center">
                                    <Label Text="{Binding CharacterName}"
                                           FontSize="17"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource HallowTextPrimary}"/>
                                    <Label Text="{Binding CharacterTitle}"
                                           FontSize="12"
                                           TextColor="{StaticResource HallowAccentPurple}"/>
                                    <Label Text="{Binding LastMessage}"
                                           FontSize="12"
                                           TextColor="{StaticResource HallowTextMuted}"
                                           LineBreakMode="TailTruncation"
                                           MaxLines="2"/>
                                </VerticalStackLayout>
                                
                                <!-- Date & Message Count -->
                                <VerticalStackLayout Grid.Column="2" Spacing="4" VerticalOptions="Center">
                                    <Label Text="{Binding StartedAt, Converter={StaticResource UtcToLocalTimeConverter}, StringFormat='{0:MMM d}'}"
                                           FontSize="12"
                                           TextColor="{StaticResource HallowTextMuted}"
                                           HorizontalOptions="End"/>
                                    <Frame BackgroundColor="{StaticResource HallowAccentPurple}"
                                           Padding="10,4"
                                           CornerRadius="12"
                                           BorderColor="Transparent"
                                           HorizontalOptions="End">
                                        <Label Text="{Binding MessageCount}"
                                               FontSize="11"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource HallowTextPrimary}"/>
                                    </Frame>
                                </VerticalStackLayout>
                            </Grid>
                        </Frame>
                    </SwipeView>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
    </Grid>
</ContentPage>
