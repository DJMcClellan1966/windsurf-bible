<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:AI_Bible_App.Maui.ViewModels"
             xmlns:models="clr-namespace:AI_Bible_App.Core.Models;assembly=AI-Bible-App.Core"
             xmlns:converters="clr-namespace:AI_Bible_App.Maui.Converters"
             x:Class="AI_Bible_App.Maui.Views.ReflectionPage"
             x:DataType="vm:ReflectionViewModel"
             x:Name="ThisPage"
             Title="{Binding Title}"
             BackgroundColor="{DynamicResource PageBackgroundColor}">

    <ContentPage.Resources>
        <converters:UtcToLocalTimeConverter x:Key="UtcToLocalTimeConverter"/>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,Auto,*">
        
        <!-- Header with Search -->
        <Grid Grid.Row="0" 
              ColumnDefinitions="*,Auto"
              Padding="15"
              BackgroundColor="{DynamicResource CardBackground}">
            
            <Border Grid.Column="0"
                    Padding="10"
                    StrokeThickness="1"
                    Stroke="{DynamicResource Gray300}"
                    BackgroundColor="{DynamicResource InputBackground}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="20"/>
                </Border.StrokeShape>
                <Entry Text="{Binding SearchText}"
                       Placeholder="Search reflections..."
                       ReturnCommand="{Binding SearchCommand}"
                       ClearButtonVisibility="WhileEditing"/>
            </Border>
            
            <Button Grid.Column="1"
                    Text="+ New"
                    Command="{Binding CreateNewReflectionCommand}"
                    Margin="10,0,0,0"
                    HeightRequest="44"
                    CornerRadius="22"
                    BackgroundColor="{DynamicResource Primary}"
                    TextColor="White"/>
        </Grid>

        <!-- Filter Tabs -->
        <HorizontalStackLayout Grid.Row="1" 
                               Spacing="8" 
                               Padding="15,5"
                               HorizontalOptions="Start">
            <Button Text="All"
                    Command="{Binding FilterByTypeCommand}"
                    CommandParameter=""
                    HeightRequest="32"
                    CornerRadius="16"
                    FontSize="12"
                    Padding="12,0"
                    BackgroundColor="{DynamicResource Primary}"
                    TextColor="White"/>
            <Button Text="â­ Favorites"
                    Command="{Binding FilterByTypeCommand}"
                    CommandParameter="favorites"
                    HeightRequest="32"
                    CornerRadius="16"
                    FontSize="12"
                    Padding="12,0"
                    BackgroundColor="{DynamicResource Gray200}"
                    TextColor="{DynamicResource TextColor}"/>
            <Button Text="ðŸ’¬ Chats"
                    Command="{Binding FilterByTypeCommand}"
                    CommandParameter="Chat"
                    HeightRequest="32"
                    CornerRadius="16"
                    FontSize="12"
                    Padding="12,0"
                    BackgroundColor="{DynamicResource Gray200}"
                    TextColor="{DynamicResource TextColor}"/>
            <Button Text="ðŸ™ Prayers"
                    Command="{Binding FilterByTypeCommand}"
                    CommandParameter="Prayer"
                    HeightRequest="32"
                    CornerRadius="16"
                    FontSize="12"
                    Padding="12,0"
                    BackgroundColor="{DynamicResource Gray200}"
                    TextColor="{DynamicResource TextColor}"/>
        </HorizontalStackLayout>

        <!-- Empty State -->
        <VerticalStackLayout Grid.Row="2"
                            IsVisible="{Binding Reflections.Count, Converter={StaticResource IntToBoolConverter}, ConverterParameter=invert}"
                            VerticalOptions="Center"
                            HorizontalOptions="Center"
                            Spacing="15"
                            Padding="30">
            <Label Text="ðŸ“" FontSize="48" HorizontalOptions="Center"/>
            <Label Text="No reflections yet"
                   FontSize="18"
                   FontAttributes="Bold"
                   HorizontalOptions="Center"
                   TextColor="{DynamicResource TextColor}"/>
            <Label Text="Save responses from chats or prayers to reflect on later. Tap '+ New' to create a custom reflection."
                   FontSize="14"
                   HorizontalTextAlignment="Center"
                   TextColor="{DynamicResource Gray600}"/>
        </VerticalStackLayout>

        <!-- Reflections List -->
        <CollectionView Grid.Row="2"
                       ItemsSource="{Binding Reflections}"
                       SelectionMode="Single"
                       SelectedItem="{Binding SelectedReflection}"
                       SelectionChangedCommand="{Binding ViewReflectionCommand}"
                       SelectionChangedCommandParameter="{Binding SelectedReflection}">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:Reflection">
                    <Border Margin="15,8"
                            Padding="15"
                            StrokeThickness="1"
                            Stroke="{DynamicResource Gray300}"
                            BackgroundColor="{DynamicResource CardBackground}">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12"/>
                        </Border.StrokeShape>
                        
                        <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto,Auto">
                            <!-- Type Icon -->
                            <Label Grid.Row="0" Grid.Column="0"
                                   Text="{Binding Type, Converter={StaticResource ReflectionTypeToEmojiConverter}}"
                                   FontSize="24"
                                   VerticalOptions="Center"
                                   Margin="0,0,12,0"/>
                            
                            <!-- Title and Character -->
                            <VerticalStackLayout Grid.Row="0" Grid.Column="1" Spacing="2">
                                <Label Text="{Binding Title}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{DynamicResource TextColor}"
                                       LineBreakMode="TailTruncation"/>
                                <Label Text="{Binding CharacterName, StringFormat='From {0}'}"
                                       FontSize="12"
                                       TextColor="{DynamicResource Gray600}"
                                       IsVisible="{Binding CharacterName, Converter={StaticResource StringToBoolConverter}}"/>
                            </VerticalStackLayout>
                            
                            <!-- Favorite Star -->
                            <Label Grid.Row="0" Grid.Column="2"
                                   Text="{Binding IsFavorite, Converter={StaticResource BoolToStarConverter}}"
                                   FontSize="20"
                                   VerticalOptions="Start">
                                <Label.GestureRecognizers>
                                    <TapGestureRecognizer 
                                        Command="{Binding Path=BindingContext.ToggleFavoriteCommand, Source={x:Reference ThisPage}}"
                                        CommandParameter="{Binding}"/>
                                </Label.GestureRecognizers>
                            </Label>
                            
                            <!-- Content Preview -->
                            <Label Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="3"
                                   Text="{Binding SavedContent}"
                                   FontSize="13"
                                   TextColor="{DynamicResource Gray600}"
                                   LineBreakMode="TailTruncation"
                                   MaxLines="2"
                                   Margin="0,8,0,0"/>
                            
                            <!-- Date and Notes indicator -->
                            <HorizontalStackLayout Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="3"
                                                   Spacing="10"
                                                   Margin="0,8,0,0">
                                <Label Text="{Binding CreatedAt, Converter={StaticResource UtcToLocalTimeConverter}, StringFormat='{0:MMM d, yyyy}'}"
                                       FontSize="11"
                                       TextColor="{DynamicResource Gray500}"/>
                                <Label Text="ðŸ“ Has notes"
                                       FontSize="11"
                                       TextColor="{DynamicResource Primary}"
                                       IsVisible="{Binding PersonalNotes, Converter={StaticResource StringToBoolConverter}}"/>
                            </HorizontalStackLayout>
                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Loading Indicator -->
        <ActivityIndicator Grid.Row="2"
                          IsRunning="{Binding IsBusy}"
                          IsVisible="{Binding IsBusy}"
                          VerticalOptions="Center"
                          HorizontalOptions="Center"
                          Color="{DynamicResource Primary}"/>
    </Grid>
</ContentPage>
