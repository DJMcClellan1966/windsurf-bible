<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:AI_Bible_App.Maui.ViewModels"
             xmlns:models="clr-namespace:AI_Bible_App.Core.Models;assembly=AI-Bible-App.Core"
             x:Class="AI_Bible_App.Maui.Views.BookmarksPage"
             x:DataType="vm:BookmarksViewModel"
             Title="{Binding Title}"
             BackgroundColor="{DynamicResource PageBackgroundColor}">

    <Grid RowDefinitions="Auto,Auto,*">
        
        <!-- Header with Search -->
        <Grid Grid.Row="0" 
              ColumnDefinitions="*,Auto"
              Padding="15"
              BackgroundColor="{DynamicResource CardBackground}">
            
            <Border Grid.Column="0"
                    Padding="10"
                    StrokeThickness="1"
                    Stroke="{DynamicResource Gray300}"
                    BackgroundColor="{DynamicResource InputBackground}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="20"/>
                </Border.StrokeShape>
                <Entry Text="{Binding SearchText}"
                       Placeholder="Search bookmarks..."
                       ReturnCommand="{Binding SearchCommand}"
                       ClearButtonVisibility="WhileEditing"/>
            </Border>
            
            <Button Grid.Column="1"
                    Text="+ Add"
                    Command="{Binding AddBookmarkCommand}"
                    Margin="10,0,0,0"
                    HeightRequest="44"
                    CornerRadius="22"
                    BackgroundColor="{DynamicResource Primary}"
                    TextColor="White"/>
        </Grid>

        <!-- Category Filter -->
        <ScrollView Grid.Row="1" Orientation="Horizontal" HorizontalScrollBarVisibility="Never">
            <HorizontalStackLayout Spacing="8" Padding="15,10">
                <Button Text="All"
                        Command="{Binding FilterByCategoryCommand}"
                        CommandParameter="All"
                        HeightRequest="32"
                        CornerRadius="16"
                        FontSize="12"
                        Padding="12,0"
                        BackgroundColor="{DynamicResource Primary}"
                        TextColor="White"/>
                <Button Text="ðŸ’ª Strength"
                        Command="{Binding FilterByCategoryCommand}"
                        CommandParameter="Strength"
                        HeightRequest="32"
                        CornerRadius="16"
                        FontSize="12"
                        Padding="12,0"
                        BackgroundColor="{DynamicResource Gray200}"
                        TextColor="{DynamicResource TextColor}"/>
                <Button Text="ðŸ¤— Comfort"
                        Command="{Binding FilterByCategoryCommand}"
                        CommandParameter="Comfort"
                        HeightRequest="32"
                        CornerRadius="16"
                        FontSize="12"
                        Padding="12,0"
                        BackgroundColor="{DynamicResource Gray200}"
                        TextColor="{DynamicResource TextColor}"/>
                <Button Text="ðŸ§  Wisdom"
                        Command="{Binding FilterByCategoryCommand}"
                        CommandParameter="Wisdom"
                        HeightRequest="32"
                        CornerRadius="16"
                        FontSize="12"
                        Padding="12,0"
                        BackgroundColor="{DynamicResource Gray200}"
                        TextColor="{DynamicResource TextColor}"/>
                <Button Text="â¤ï¸ Love"
                        Command="{Binding FilterByCategoryCommand}"
                        CommandParameter="Love"
                        HeightRequest="32"
                        CornerRadius="16"
                        FontSize="12"
                        Padding="12,0"
                        BackgroundColor="{DynamicResource Gray200}"
                        TextColor="{DynamicResource TextColor}"/>
                <Button Text="âœï¸ Faith"
                        Command="{Binding FilterByCategoryCommand}"
                        CommandParameter="Faith"
                        HeightRequest="32"
                        CornerRadius="16"
                        FontSize="12"
                        Padding="12,0"
                        BackgroundColor="{DynamicResource Gray200}"
                        TextColor="{DynamicResource TextColor}"/>
                <Button Text="ðŸ•Šï¸ Peace"
                        Command="{Binding FilterByCategoryCommand}"
                        CommandParameter="Peace"
                        HeightRequest="32"
                        CornerRadius="16"
                        FontSize="12"
                        Padding="12,0"
                        BackgroundColor="{DynamicResource Gray200}"
                        TextColor="{DynamicResource TextColor}"/>
            </HorizontalStackLayout>
        </ScrollView>

        <!-- Main Content -->
        <Grid Grid.Row="2">
            
            <!-- Empty State -->
            <VerticalStackLayout IsVisible="{Binding Bookmarks.Count, Converter={StaticResource IntToBoolConverter}, ConverterParameter=invert}"
                                VerticalOptions="Center"
                                HorizontalOptions="Center"
                                Spacing="15"
                                Padding="30">
                <Label Text="ðŸ”–" FontSize="48" HorizontalOptions="Center"/>
                <Label Text="No bookmarks yet"
                       FontSize="18"
                       FontAttributes="Bold"
                       HorizontalOptions="Center"
                       TextColor="{DynamicResource TextColor}"/>
                <Label Text="Save your favorite Bible verses to easily find them later. Tap '+ Add' to bookmark a verse."
                       FontSize="14"
                       HorizontalTextAlignment="Center"
                       TextColor="{DynamicResource Gray600}"/>
            </VerticalStackLayout>

            <!-- Bookmarks List -->
            <CollectionView ItemsSource="{Binding Bookmarks}"
                           SelectionMode="Single"
                           SelectedItem="{Binding SelectedBookmark}"
                           SelectionChangedCommand="{Binding ViewBookmarkCommand}"
                           SelectionChangedCommandParameter="{Binding SelectedBookmark}">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:VerseBookmark">
                        <Border Margin="15,8"
                                Padding="15"
                                BackgroundColor="{DynamicResource CardBackground}"
                                StrokeThickness="1"
                                Stroke="{DynamicResource Gray200}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12"/>
                            </Border.StrokeShape>
                            <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,Auto">
                                <!-- Reference & Category -->
                                <HorizontalStackLayout Grid.Row="0" Grid.Column="0" Spacing="8">
                                    <Label Text="{Binding VerseReference}"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="{DynamicResource Primary}"/>
                                    <Border Padding="6,2"
                                            BackgroundColor="{DynamicResource Gray100}"
                                            StrokeThickness="0"
                                            IsVisible="{Binding Category, Converter={StaticResource StringNotEmptyConverter}}">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="8"/>
                                        </Border.StrokeShape>
                                        <Label Text="{Binding Category}"
                                               FontSize="10"
                                               TextColor="{DynamicResource Gray600}"/>
                                    </Border>
                                </HorizontalStackLayout>
                                
                                <!-- Date -->
                                <Label Grid.Row="0" Grid.Column="1"
                                       Text="{Binding CreatedAt, StringFormat='{0:MMM d}'}"
                                       FontSize="12"
                                       TextColor="{DynamicResource Gray500}"
                                       VerticalOptions="Center"/>
                                
                                <!-- Verse Text -->
                                <Label Grid.Row="1" Grid.ColumnSpan="2"
                                       Text="{Binding VerseText}"
                                       FontSize="14"
                                       TextColor="{DynamicResource TextColor}"
                                       MaxLines="2"
                                       LineBreakMode="TailTruncation"
                                       Margin="0,8,0,0"/>
                                
                                <!-- Note Preview -->
                                <Label Grid.Row="2" Grid.ColumnSpan="2"
                                       Text="{Binding Note, StringFormat='ðŸ“ {0}'}"
                                       FontSize="12"
                                       TextColor="{DynamicResource Gray500}"
                                       MaxLines="1"
                                       LineBreakMode="TailTruncation"
                                       Margin="0,5,0,0"
                                       IsVisible="{Binding Note, Converter={StaticResource StringNotEmptyConverter}}"/>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Detail Panel (Overlay when bookmark selected) -->
            <Border IsVisible="{Binding SelectedBookmark, Converter={StaticResource NullToBoolConverter}}"
                    BackgroundColor="{DynamicResource PageBackgroundColor}"
                    Padding="0">
                <ScrollView>
                    <VerticalStackLayout Spacing="15" Padding="15">
                        
                        <!-- Close Button -->
                        <HorizontalStackLayout HorizontalOptions="End">
                            <Button Text="âœ•"
                                    Command="{Binding CloseDetailCommand}"
                                    HeightRequest="36"
                                    WidthRequest="36"
                                    CornerRadius="18"
                                    Padding="0"
                                    BackgroundColor="{DynamicResource Gray200}"
                                    TextColor="{DynamicResource TextColor}"/>
                        </HorizontalStackLayout>

                        <!-- Reference Header -->
                        <Border Padding="20"
                                BackgroundColor="{DynamicResource Primary}"
                                StrokeThickness="0">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12"/>
                            </Border.StrokeShape>
                            <VerticalStackLayout Spacing="8">
                                <Label Text="{Binding SelectedBookmark.Category}"
                                       FontSize="12"
                                       TextColor="White"
                                       Opacity="0.8"/>
                                <Label Text="{Binding SelectedBookmark.VerseReference}"
                                       FontSize="22"
                                       FontAttributes="Bold"
                                       TextColor="White"/>
                            </VerticalStackLayout>
                        </Border>

                        <!-- Verse Text -->
                        <Border Padding="20"
                                BackgroundColor="{DynamicResource CardBackground}"
                                StrokeThickness="1"
                                Stroke="{DynamicResource Gray300}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12"/>
                            </Border.StrokeShape>
                            <Label Text="{Binding SelectedBookmark.VerseText}"
                                   FontSize="16"
                                   FontAttributes="Italic"
                                   TextColor="{DynamicResource TextColor}"
                                   LineHeight="1.5"/>
                        </Border>

                        <!-- Note Section (View Mode) -->
                        <Border IsVisible="{Binding IsEditing, Converter={StaticResource InvertedBoolConverter}}"
                                Padding="20"
                                BackgroundColor="{DynamicResource CardBackground}"
                                StrokeThickness="1"
                                Stroke="{DynamicResource Gray300}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12"/>
                            </Border.StrokeShape>
                            <VerticalStackLayout Spacing="10">
                                <HorizontalStackLayout Spacing="8">
                                    <Label Text="ðŸ“" FontSize="16"/>
                                    <Label Text="My Notes"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="{DynamicResource Gray600}"/>
                                </HorizontalStackLayout>
                                <Label Text="{Binding SelectedBookmark.Note, TargetNullValue='No notes added yet. Tap Edit to add your thoughts.'}"
                                       FontSize="14"
                                       TextColor="{DynamicResource TextColor}"/>
                            </VerticalStackLayout>
                        </Border>

                        <!-- Note Section (Edit Mode) -->
                        <Border IsVisible="{Binding IsEditing}"
                                Padding="20"
                                BackgroundColor="{DynamicResource CardBackground}"
                                StrokeThickness="1"
                                Stroke="{DynamicResource Primary}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12"/>
                            </Border.StrokeShape>
                            <VerticalStackLayout Spacing="15">
                                <Label Text="Edit Bookmark"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{DynamicResource TextColor}"/>
                                
                                <VerticalStackLayout Spacing="5">
                                    <Label Text="Category" FontSize="12" TextColor="{DynamicResource Gray600}"/>
                                    <Picker ItemsSource="{Binding Categories}"
                                            SelectedItem="{Binding EditCategory}"
                                            BackgroundColor="{DynamicResource InputBackground}"/>
                                </VerticalStackLayout>
                                
                                <VerticalStackLayout Spacing="5">
                                    <Label Text="Notes" FontSize="12" TextColor="{DynamicResource Gray600}"/>
                                    <Editor Text="{Binding EditNote}"
                                            Placeholder="Add your thoughts about this verse..."
                                            HeightRequest="120"
                                            BackgroundColor="{DynamicResource InputBackground}"/>
                                </VerticalStackLayout>
                                
                                <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                                    <Button Grid.Column="0"
                                            Text="Cancel"
                                            Command="{Binding CancelEditingCommand}"
                                            HeightRequest="44"
                                            CornerRadius="8"
                                            BackgroundColor="{DynamicResource Gray200}"
                                            TextColor="{DynamicResource TextColor}"/>
                                    <Button Grid.Column="1"
                                            Text="Save"
                                            Command="{Binding SaveBookmarkCommand}"
                                            HeightRequest="44"
                                            CornerRadius="8"
                                            BackgroundColor="{DynamicResource Primary}"
                                            TextColor="White"/>
                                </Grid>
                            </VerticalStackLayout>
                        </Border>

                        <!-- Tags -->
                        <Border IsVisible="{Binding SelectedBookmark.Tags.Count, Converter={StaticResource IntToBoolConverter}}"
                                Padding="15"
                                BackgroundColor="{DynamicResource CardBackground}"
                                StrokeThickness="1"
                                Stroke="{DynamicResource Gray300}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12"/>
                            </Border.StrokeShape>
                            <VerticalStackLayout Spacing="10">
                                <Label Text="ðŸ·ï¸ Tags" FontSize="14" FontAttributes="Bold" TextColor="{DynamicResource Gray600}"/>
                                <FlexLayout BindableLayout.ItemsSource="{Binding SelectedBookmark.Tags}"
                                           Wrap="Wrap"
                                           JustifyContent="Start">
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="x:String">
                                            <Border Margin="0,0,8,8"
                                                    Padding="10,5"
                                                    BackgroundColor="{DynamicResource PrimaryLight}"
                                                    StrokeThickness="0">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="12"/>
                                                </Border.StrokeShape>
                                                <Label Text="{Binding .}"
                                                       FontSize="12"
                                                       TextColor="{DynamicResource Primary}"/>
                                            </Border>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>
                                </FlexLayout>
                            </VerticalStackLayout>
                        </Border>

                        <!-- Action Buttons -->
                        <Grid ColumnDefinitions="*,*,*" ColumnSpacing="10" Margin="0,10"
                              IsVisible="{Binding IsEditing, Converter={StaticResource InvertedBoolConverter}}">
                            <Button Grid.Column="0"
                                    Text="âœï¸ Edit"
                                    Command="{Binding StartEditingBookmarkCommand}"
                                    HeightRequest="44"
                                    CornerRadius="8"
                                    BackgroundColor="{DynamicResource Gray200}"
                                    TextColor="{DynamicResource TextColor}"/>
                            <Button Grid.Column="1"
                                    Text="ðŸ“¤ Share"
                                    Command="{Binding ShareBookmarkCommand}"
                                    HeightRequest="44"
                                    CornerRadius="8"
                                    BackgroundColor="{DynamicResource Primary}"
                                    TextColor="White"/>
                            <Button Grid.Column="2"
                                    Text="ðŸ—‘ï¸"
                                    Command="{Binding DeleteBookmarkCommand}"
                                    HeightRequest="44"
                                    CornerRadius="8"
                                    BackgroundColor="{DynamicResource Danger}"
                                    TextColor="White"/>
                        </Grid>

                        <!-- Metadata -->
                        <Label Text="{Binding SelectedBookmark.CreatedAt, StringFormat='Bookmarked on {0:MMMM d, yyyy}'}"
                               FontSize="12"
                               TextColor="{DynamicResource Gray500}"
                               HorizontalOptions="Center"/>

                    </VerticalStackLayout>
                </ScrollView>
            </Border>
        </Grid>
    </Grid>
</ContentPage>
