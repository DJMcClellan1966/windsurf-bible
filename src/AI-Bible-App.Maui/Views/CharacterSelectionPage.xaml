<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:AI_Bible_App.Maui.ViewModels"
             xmlns:models="clr-namespace:AI_Bible_App.Core.Models;assembly=AI-Bible-App.Core"
             x:Class="AI_Bible_App.Maui.Views.CharacterSelectionPage"
             x:DataType="vm:CharacterSelectionViewModel"
             Title="{Binding Title}"
             BackgroundColor="{DynamicResource PageBackgroundColor}">
    
    <Grid RowDefinitions="Auto,Auto,*,Auto,Auto" Padding="{StaticResource PageMargin}">
        
        <!-- Header -->
        <VerticalStackLayout Grid.Row="0" Spacing="{StaticResource CardSpacing}" Margin="0,10,0,15">
            <Label Text="ðŸ“– Voices of Scripture"
                   FontSize="{StaticResource TitleFontSize}"
                   FontAttributes="Bold"
                   HorizontalOptions="Center"
                   TextColor="{DynamicResource Primary}"
                   AutomationProperties.IsInAccessibleTree="True"
                   SemanticProperties.HeadingLevel="Level1"
                   SemanticProperties.Description="Main page heading - Voices of Scripture app"/>
            <Label Text="Swipe to explore â€¢ Tap to chat"
                   FontSize="{StaticResource SubtitleFontSize}"
                   HorizontalOptions="Center"
                   TextColor="{DynamicResource Gray600}"
                   AutomationProperties.IsInAccessibleTree="True"
                   SemanticProperties.Hint="Use arrow keys or swipe to browse biblical characters"/>
            
            <!-- Ollama Status Indicator -->
            <Border Padding="8,5"
                    Margin="0,5,0,0"
                    HorizontalOptions="Center"
                    BackgroundColor="{DynamicResource CardBackground}"
                    StrokeThickness="1"
                    Stroke="{DynamicResource Gray300}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="15"/>
                </Border.StrokeShape>
                <Border.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding CheckOllamaStatusCommand}"/>
                </Border.GestureRecognizers>
                <Label Text="{Binding OllamaStatusText}"
                       FontSize="{StaticResource CaptionFontSize}"
                       TextColor="{Binding OllamaStatusColor}"
                       HorizontalOptions="Center"
                       AutomationProperties.IsInAccessibleTree="True"/>
            </Border>
        </VerticalStackLayout>

        <!-- View Mode Toggle -->
        <HorizontalStackLayout Grid.Row="1" 
                               HorizontalOptions="Center" 
                               Spacing="10"
                               Margin="0,0,0,10">
            <Button Text="ðŸŽ´ Cards"
                    x:Name="CardsViewButton"
                    Clicked="OnCardsViewClicked"
                    BackgroundColor="{DynamicResource Primary}"
                    TextColor="White"
                    HeightRequest="{StaticResource ButtonHeight}"
                    CornerRadius="18"
                    FontSize="{StaticResource ButtonFontSize}"
                    Padding="15,0"
                    SemanticProperties.Description="Card view"/>
            <Button Text="ðŸ“‹ List"
                    x:Name="ListViewButton"
                    Clicked="OnListViewClicked"
                    BackgroundColor="{DynamicResource Gray300}"
                    TextColor="{DynamicResource Gray800}"
                    HeightRequest="{StaticResource ButtonHeight}"
                    CornerRadius="18"
                    FontSize="{StaticResource ButtonFontSize}"
                    Padding="15,0"
                    SemanticProperties.Description="List view"/>
        </HorizontalStackLayout>

        <!-- Swipe Character Carousel (Card View) -->
        <Grid Grid.Row="2" x:Name="CarouselContainer">
            <CarouselView x:Name="CharacterCarousel"
                          ItemsSource="{Binding Characters}"
                          Loop="True"
                          PeekAreaInsets="40"
                          CurrentItemChanged="OnCarouselItemChanged"
                          SemanticProperties.Description="Character selector carousel">
                <CarouselView.ItemTemplate>
                    <DataTemplate x:DataType="models:BiblicalCharacter">
                        <Border Padding="20"
                                Margin="10,20"
                                BackgroundColor="{DynamicResource CardBackground}"
                                Shadow="{Shadow Brush=Black, Offset='0,4', Radius=8, Opacity=0.4}"
                                AutomationProperties.IsInAccessibleTree="True"
                                SemanticProperties.Description="{Binding Name}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="20"/>
                            </Border.StrokeShape>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnCharacterCardTapped"/>
                            </Border.GestureRecognizers>
                            
                            <VerticalStackLayout Spacing="{StaticResource CardSpacing}" HorizontalOptions="Center">
                                <!-- Large Avatar -->
                                <Border WidthRequest="{StaticResource AvatarSize}"
                                        HeightRequest="{StaticResource AvatarSize}"
                                        Padding="0"
                                        HorizontalOptions="Center"
                                        BackgroundColor="{DynamicResource Primary}">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="60"/>
                                    </Border.StrokeShape>
                                    <Label Text="{Binding Name, StringFormat='{0:substring(0,1)}'}"
                                           FontSize="50"
                                           FontAttributes="Bold"
                                           TextColor="White"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"/>
                                </Border>
                                
                                <!-- Character Name -->
                                <Label Text="{Binding Name, Converter={StaticResource ShortNameConverter}}"
                                       FontSize="{StaticResource TitleFontSize}"
                                       FontAttributes="Bold"
                                       TextColor="{DynamicResource Primary}"
                                       HorizontalOptions="Center"
                                       HorizontalTextAlignment="Center"/>
                                
                                <!-- Title/Role -->
                                <Label Text="{Binding Title}"
                                       FontSize="{StaticResource SubtitleFontSize}"
                                       FontAttributes="Italic"
                                       TextColor="{DynamicResource Gray600}"
                                       HorizontalOptions="Center"
                                       HorizontalTextAlignment="Center"/>
                                
                                <!-- Decorative Divider -->
                                <Label Text="âœ¦ â”€â”€â”€â”€â”€â”€â”€ âœ¦"
                                       FontSize="14"
                                       TextColor="{DynamicResource Gray400}"
                                       HorizontalOptions="Center"
                                       Margin="0,5"/>
                                
                                <!-- Description -->
                                <Label Text="{Binding Description}"
                                       FontSize="{StaticResource BodyFontSize}"
                                       TextColor="{DynamicResource Gray600}"
                                       HorizontalOptions="Center"
                                       HorizontalTextAlignment="Center"
                                       LineBreakMode="WordWrap"
                                       MaxLines="4"
                                       Margin="10,0"/>
                                
                                <!-- Era Badge -->
                                <Border Padding="12,6"
                                        BackgroundColor="{DynamicResource PrimaryLight}"
                                        HorizontalOptions="Center"
                                        Margin="0,10,0,0">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="15"/>
                                    </Border.StrokeShape>
                                    <Label Text="{Binding Era}"
                                           FontSize="{StaticResource CaptionFontSize}"
                                           FontAttributes="Bold"
                                           TextColor="{DynamicResource Primary}"
                                           HorizontalOptions="Center"/>
                                </Border>
                                
                                <!-- Tap to Chat Hint -->
                                <Label Text="ðŸ‘† Tap to start conversation"
                                       FontSize="13"
                                       TextColor="{DynamicResource Gray500}"
                                       HorizontalOptions="Center"
                                       Margin="0,15,0,0"/>
                            </VerticalStackLayout>
                        </Border>
                    </DataTemplate>
                </CarouselView.ItemTemplate>
            </CarouselView>
            
            <!-- Swipe Indicators -->
            <HorizontalStackLayout HorizontalOptions="Center" 
                                   VerticalOptions="End"
                                   Spacing="8"
                                   Margin="0,0,0,10">
                <Label Text="â—€ Swipe"
                       FontSize="12"
                       TextColor="{DynamicResource Gray500}"/>
                <IndicatorView x:Name="CharacterIndicator"
                               IndicatorColor="{DynamicResource Gray400}"
                               SelectedIndicatorColor="{DynamicResource Primary}"
                               IndicatorSize="8"
                               HorizontalOptions="Center"/>
                <Label Text="Swipe â–¶"
                       FontSize="12"
                       TextColor="{DynamicResource Gray500}"/>
            </HorizontalStackLayout>
        </Grid>

        <!-- List View (Alternative) -->
        <ScrollView Grid.Row="2" x:Name="ListContainer" IsVisible="False">
            <VerticalStackLayout Spacing="10" Padding="0,10">
                <CollectionView ItemsSource="{Binding Characters}"
                                SelectionMode="Single"
                                SelectionChanged="OnCharacterSelected">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:BiblicalCharacter">
                            <SwipeView SemanticProperties.Description="{Binding Name}">
                                <SwipeView.LeftItems>
                                    <SwipeItems Mode="Execute">
                                        <SwipeItem Text="ðŸ’¬ Chat"
                                                   BackgroundColor="{DynamicResource Primary}"
                                                   Invoked="OnSwipeChatInvoked"/>
                                    </SwipeItems>
                                </SwipeView.LeftItems>
                                <SwipeView.RightItems>
                                    <SwipeItems Mode="Execute">
                                        <SwipeItem Text="â„¹ï¸ Info"
                                                   BackgroundColor="{DynamicResource Secondary}"
                                                   Invoked="OnSwipeInfoInvoked"/>
                                    </SwipeItems>
                                </SwipeView.RightItems>
                                
                                <Border Padding="12"
                                        Margin="5,0"
                                        BackgroundColor="{DynamicResource CardBackground}"
                                        Shadow="{Shadow Brush=Black, Offset='0,2', Radius=4, Opacity=0.3}">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="12"/>
                                    </Border.StrokeShape>
                                    
                                    <Grid ColumnDefinitions="70,*,Auto" ColumnSpacing="12">
                                        <!-- Avatar with Name Below -->
                                        <VerticalStackLayout Grid.Column="0" Spacing="4" VerticalOptions="Center">
                                            <Border WidthRequest="{StaticResource AvatarSize}"
                                                    HeightRequest="{StaticResource AvatarSize}"
                                                    Padding="0"
                                                    HorizontalOptions="Center"
                                                    BackgroundColor="{DynamicResource Primary}">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="27"/>
                                                </Border.StrokeShape>
                                                <Label Text="{Binding Name, StringFormat='{0:substring(0,1)}'}"
                                                       FontSize="26"
                                                       FontAttributes="Bold"
                                                       TextColor="White"
                                                       HorizontalOptions="Center"
                                                       VerticalOptions="Center"/>
                                            </Border>
                                        </VerticalStackLayout>
                                        
                                        <!-- Character Info -->
                                        <VerticalStackLayout Grid.Column="1" Spacing="3" VerticalOptions="Center">
                                            <Label Text="{Binding Name, Converter={StaticResource ShortNameConverter}}"
                                                   FontSize="{StaticResource SubtitleFontSize}"
                                                   FontAttributes="Bold"
                                                   TextColor="{DynamicResource Primary}"
                                                   LineBreakMode="TailTruncation"/>
                                            <Label Text="{Binding Title}"
                                                   FontSize="{StaticResource BodyFontSize}"
                                                   TextColor="{DynamicResource Gray600}"
                                                   LineBreakMode="TailTruncation"/>
                                            <Label Text="{Binding Description}"
                                                   FontSize="{StaticResource CaptionFontSize}"
                                                   TextColor="{DynamicResource Gray500}"
                                                   LineBreakMode="WordWrap"
                                                   MaxLines="2"/>
                                        </VerticalStackLayout>
                                        
                                        <!-- Swipe Hint Arrow -->
                                        <Label Grid.Column="2"
                                               Text="âŸ·"
                                               FontSize="18"
                                               TextColor="{DynamicResource Gray400}"
                                               VerticalOptions="Center"/>
                                    </Grid>
                                </Border>
                            </SwipeView>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>
        </ScrollView>

        <!-- Loading Indicator -->
        <Label Grid.Row="2"
               Text="Loading characters..."
               IsVisible="{Binding IsBusy}"
               FontSize="{StaticResource SubtitleFontSize}"
               TextColor="{DynamicResource Gray600}"
               HorizontalOptions="Center"
               VerticalOptions="Center"/>

        <!-- Action Buttons -->
        <Grid Grid.Row="3" ColumnDefinitions="*,*" ColumnSpacing="{StaticResource CardSpacing}" Margin="0,15,0,0">
            <Button Grid.Column="0"
                    Text="ðŸ™ Prayer"
                    Command="{Binding NavigateToPrayerCommand}"
                    HeightRequest="{StaticResource ButtonHeight}"
                    FontSize="{StaticResource ButtonFontSize}"
                    BackgroundColor="{DynamicResource Primary}"
                    TextColor="White"
                    CornerRadius="10"
                    SemanticProperties.Description="Generate a Prayer"/>
            <Button Grid.Column="1"
                    Text="ðŸ“– Bible"
                    Clicked="OnBibleReaderClicked"
                    HeightRequest="{StaticResource ButtonHeight}"
                    FontSize="{StaticResource ButtonFontSize}"
                    BackgroundColor="{DynamicResource Secondary}"
                    TextColor="White"
                    CornerRadius="10"
                    SemanticProperties.Description="Open Bible Reader"/>
        </Grid>
        
        <!-- Bottom Navigation -->
        <Grid Grid.Row="4" ColumnDefinitions="*,*,*" Margin="0,10,0,0">
            <Button Grid.Column="0"
                    Text="ðŸ“Š"
                    Clicked="OnHistoryClicked"
                    BackgroundColor="Transparent"
                    TextColor="{DynamicResource Gray600}"
                    FontSize="{StaticResource TitleFontSize}"
                    HeightRequest="50"
                    SemanticProperties.Description="View History"/>
            <Button Grid.Column="1"
                    Text="âž•"
                    Clicked="OnCreateCharacterClicked"
                    BackgroundColor="Transparent"
                    TextColor="{DynamicResource Primary}"
                    FontSize="28"
                    FontAttributes="Bold"
                    HeightRequest="50"
                    SemanticProperties.Description="Create Custom Character"/>
            <Button Grid.Column="2"
                    Text="âš™ï¸"
                    Command="{Binding NavigateToSettingsCommand}"
                    BackgroundColor="Transparent"
                    TextColor="{DynamicResource Gray600}"
                    FontSize="24"
                    HeightRequest="50"
                    SemanticProperties.Description="Settings"/>
        </Grid>
        
        <!-- Loading Overlay -->
        <ActivityIndicator Grid.RowSpan="5"
                          IsRunning="{Binding IsBusy}"
                          IsVisible="{Binding IsBusy}"
                          Color="{DynamicResource Primary}"
                          WidthRequest="50"
                          HeightRequest="50"
                          HorizontalOptions="Center"
                          VerticalOptions="Center"/>
    </Grid>
</ContentPage>
