<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:AI_Bible_App.Maui.ViewModels"
             x:Class="AI_Bible_App.Maui.Views.SettingsPage"
             x:DataType="vm:SettingsViewModel"
             Title="{Binding Title}">

    <!-- Hallow gradient background -->
    <ContentPage.Background>
        <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
            <GradientStop Color="{StaticResource HallowDarkPurple}" Offset="0.0" />
            <GradientStop Color="{StaticResource HallowDeepBlue}" Offset="0.5" />
            <GradientStop Color="{StaticResource HallowMidPurple}" Offset="1.0" />
        </LinearGradientBrush>
    </ContentPage.Background>
    
    <ScrollView Padding="15">
        <VerticalStackLayout Spacing="15">
            
            <!-- Header -->
            <Label Text="âš™ï¸ Settings"
                   FontSize="28"
                   FontAttributes="Bold"
                   HorizontalOptions="Center"
                   TextColor="{StaticResource HallowTextPrimary}"
                   Margin="0,5,0,10"/>
            
            <!-- User Profile Section -->
            <Frame Padding="20"
                   BackgroundColor="{StaticResource HallowCardBackground}"
                   BorderColor="Transparent"
                   CornerRadius="20">
                
                <VerticalStackLayout Spacing="15">
                    <Label Text="ðŸ‘¤ User Profile"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{StaticResource HallowTextPrimary}"/>
                    
                    <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="15">
                        <Frame Grid.Column="0" 
                               WidthRequest="56" HeightRequest="56"
                               CornerRadius="28" Padding="0"
                               BorderColor="Transparent">
                            <Frame.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                    <GradientStop Color="{StaticResource HallowAccentPurple}" Offset="0.0" />
                                    <GradientStop Color="{StaticResource HallowRose}" Offset="1.0" />
                                </LinearGradientBrush>
                            </Frame.Background>
                            <Label Text="{Binding CurrentUserEmoji}" 
                                   FontSize="26"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center"/>
                        </Frame>
                        
                        <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="3">
                            <Label Text="{Binding CurrentUserName}" 
                                   FontSize="18" 
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource HallowTextPrimary}"/>
                            <Label Text="{Binding CurrentUserSince, StringFormat='Member since {0:MMM d, yyyy}'}" 
                                   FontSize="12" 
                                   TextColor="{StaticResource HallowTextMuted}"/>
                        </VerticalStackLayout>
                        
                        <Button Grid.Column="2"
                                Text="Switch"
                                Command="{Binding SwitchUserCommand}"
                                BackgroundColor="{StaticResource HallowCardHover}"
                                TextColor="{StaticResource HallowTextPrimary}"
                                CornerRadius="15"
                                HeightRequest="40"
                                Padding="15,0"/>
                    </Grid>
                </VerticalStackLayout>
            </Frame>
            
            <!-- Appearance Section -->
            <Frame Padding="20"
                   BackgroundColor="{StaticResource HallowCardBackground}"
                   BorderColor="Transparent"
                   CornerRadius="20">
                
                <VerticalStackLayout Spacing="15">
                    <Label Text="ðŸŽ¨ Appearance"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{StaticResource HallowTextPrimary}"/>
                    
                    <!-- Theme Selection -->
                    <VerticalStackLayout Spacing="5">
                        <Label Text="Theme"
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="{StaticResource HallowTextPrimary}"/>
                        <Label Text="Choose how the app looks"
                               FontSize="12"
                               TextColor="{StaticResource HallowTextMuted}"/>
                        <Frame Padding="5" BackgroundColor="{StaticResource HallowCardHover}" 
                               BorderColor="Transparent" CornerRadius="12">
                            <Picker ItemsSource="{Binding ThemeOptions}"
                                    SelectedItem="{Binding SelectedTheme}"
                                    TextColor="{StaticResource HallowTextPrimary}"/>
                        </Frame>
                    </VerticalStackLayout>
                    
                    <!-- Font Size Selection -->
                    <VerticalStackLayout Spacing="5" Margin="0,10,0,0">
                        <Label Text="Font Size"
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="{StaticResource HallowTextPrimary}"/>
                        <Label Text="Adjust text size for better readability"
                               FontSize="12"
                               TextColor="{StaticResource HallowTextMuted}"/>
                        <Frame Padding="5" BackgroundColor="{StaticResource HallowCardHover}" 
                               BorderColor="Transparent" CornerRadius="12">
                            <Picker ItemsSource="{Binding FontSizeOptions}"
                                    SelectedItem="{Binding SelectedFontSize}"
                                    TextColor="{StaticResource HallowTextPrimary}"/>
                        </Frame>
                    </VerticalStackLayout>
                </VerticalStackLayout>
            </Frame>
            
            <!-- Offline AI Models Section -->
            <Frame Padding="20"
                   BackgroundColor="{StaticResource HallowCardBackground}"
                   BorderColor="Transparent"
                   CornerRadius="20">
                
                <VerticalStackLayout Spacing="15">
                    <Label Text="ðŸ¤– Offline AI Models"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{StaticResource HallowTextPrimary}"/>
                    
                    <Label Text="Download AI models to chat without internet. Perfect for travel or areas with limited connectivity."
                           FontSize="13"
                           TextColor="{StaticResource HallowTextSecondary}"/>
                    
                    <Button Text="ðŸ“¥ Manage Offline Models"
                            Command="{Binding NavigateToOfflineModelsCommand}"
                            HeightRequest="50"
                            CornerRadius="25"
                            FontAttributes="Bold"
                            TextColor="{StaticResource HallowTextPrimary}">
                        <Button.Background>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                <GradientStop Color="{StaticResource HallowAccentPurple}" Offset="0.0" />
                                <GradientStop Color="{StaticResource HallowRose}" Offset="1.0" />
                            </LinearGradientBrush>
                        </Button.Background>
                    </Button>
                    
                    <Label Text="ðŸ’¡ Tip: Download Phi 3.5 Mini for the best balance of speed and quality"
                           FontSize="11"
                           FontAttributes="Italic"
                           TextColor="{StaticResource HallowTextMuted}"/>
                </VerticalStackLayout>
            </Frame>
            
            <!-- Content Moderation Section -->
            <Frame Padding="20"
                   BackgroundColor="{StaticResource HallowCardBackground}"
                   BorderColor="Transparent"
                   CornerRadius="20">
                
                <VerticalStackLayout Spacing="15">
                    <Label Text="ðŸ›¡ï¸ Content Moderation"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{StaticResource HallowTextPrimary}"/>
                    
                    <Label Text="Filter inappropriate language to maintain a respectful environment."
                           FontSize="13"
                           TextColor="{StaticResource HallowTextSecondary}"/>
                    
                    <Grid ColumnDefinitions="*,Auto">
                        <Label Grid.Column="0" 
                               Text="Enable Content Filter"
                               TextColor="{StaticResource HallowTextPrimary}"
                               VerticalOptions="Center"/>
                        <Switch Grid.Column="1" 
                                IsToggled="{Binding IsModerationEnabled}"
                                OnColor="{StaticResource HallowAccentPurple}"/>
                    </Grid>
                </VerticalStackLayout>
            </Frame>
            
            <!-- Daily Reminder Section -->
            <Frame Padding="20"
                   BackgroundColor="{StaticResource HallowCardBackground}"
                   BorderColor="Transparent"
                   CornerRadius="20">
                
                <VerticalStackLayout Spacing="15">
                    <Label Text="ðŸ”” Daily Reminders"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{StaticResource HallowTextPrimary}"/>
                    
                    <Label Text="Get a gentle reminder each day for your devotional time."
                           FontSize="13"
                           TextColor="{StaticResource HallowTextSecondary}"/>
                    
                    <Grid ColumnDefinitions="*,Auto">
                        <Label Grid.Column="0" 
                               Text="Enable Daily Reminder"
                               TextColor="{StaticResource HallowTextPrimary}"
                               VerticalOptions="Center"/>
                        <Switch Grid.Column="1" 
                                IsToggled="{Binding IsDailyReminderEnabled}"
                                OnColor="{StaticResource HallowAccentPurple}"/>
                    </Grid>
                    
                    <!-- Reminder Time (only visible when enabled) -->
                    <VerticalStackLayout Spacing="10" IsVisible="{Binding IsDailyReminderEnabled}">
                        <Label Text="Reminder Time"
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="{StaticResource HallowTextPrimary}"/>
                        <Frame Padding="5" BackgroundColor="{StaticResource HallowCardHover}" 
                               BorderColor="Transparent" CornerRadius="12">
                            <TimePicker Time="{Binding ReminderTime}"
                                        Format="h:mm tt"
                                        TextColor="{StaticResource HallowTextPrimary}"/>
                        </Frame>
                        
                        <Label Text="{Binding ReminderTimeDescription}"
                               FontSize="12"
                               TextColor="{StaticResource HallowTextMuted}"
                               FontAttributes="Italic"/>
                    </VerticalStackLayout>
                </VerticalStackLayout>
            </Frame>
            
            <!-- PIN Protection Section -->
            <Frame Padding="20"
                   BackgroundColor="{StaticResource HallowCardBackground}"
                   BorderColor="Transparent"
                   CornerRadius="20">
                
                <VerticalStackLayout Spacing="15">
                    <Label Text="ðŸ” Privacy Protection"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{StaticResource HallowTextPrimary}"/>
                    
                    <Label Text="Set a PIN to protect your profile from other users on this device."
                           FontSize="13"
                           TextColor="{StaticResource HallowTextSecondary}"/>
                    
                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                        <VerticalStackLayout Grid.Column="0" VerticalOptions="Center" Spacing="3">
                            <Label Text="{Binding HasPinEnabled, Converter={StaticResource BoolToYesNoConverter}, StringFormat='PIN Protection: {0}'}"
                                   FontSize="14"
                                   TextColor="{StaticResource HallowTextPrimary}"/>
                            <Label Text="Your prayers, reflections, and chats stay private"
                                   FontSize="11"
                                   TextColor="{StaticResource HallowTextMuted}"
                                   IsVisible="{Binding HasPinEnabled}"/>
                        </VerticalStackLayout>
                        
                        <!-- Set/Change PIN Button -->
                        <Button Grid.Column="1"
                                Text="{Binding HasPinEnabled, Converter={StaticResource BoolToSetChangeConverter}}"
                                Command="{Binding SetOrChangePinCommand}"
                                BackgroundColor="{StaticResource HallowAccentPurple}"
                                TextColor="{StaticResource HallowTextPrimary}"
                                CornerRadius="15"
                                HeightRequest="40"
                                Padding="15,0"
                                WidthRequest="100"/>
                    </Grid>
                    
                    <!-- Remove PIN Button (only visible when PIN is set) -->
                    <Button Text="Remove PIN"
                            Command="{Binding RemovePinCommand}"
                            BackgroundColor="{StaticResource HallowCardHover}"
                            TextColor="{StaticResource HallowTextSecondary}"
                            CornerRadius="15"
                            HeightRequest="40"
                            IsVisible="{Binding HasPinEnabled}"
                            HorizontalOptions="Start"/>
                </VerticalStackLayout>
            </Frame>
            
            <!-- Cross-Device Sync Section -->
            <Frame Padding="20"
                   BackgroundColor="{StaticResource HallowCardBackground}"
                   BorderColor="Transparent"
                   CornerRadius="20">
                
                <VerticalStackLayout Spacing="15">
                    <Label Text="â˜ï¸ Cross-Device Sync"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{StaticResource HallowTextPrimary}"/>
                    
                    <Label Text="Access your chats, prayers, and reflections from any device. No account needed - just share a simple sync code."
                           FontSize="13"
                           TextColor="{StaticResource HallowTextSecondary}"/>
                    
                    <!-- Sync Status -->
                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                        <VerticalStackLayout Grid.Column="0" Spacing="3">
                            <Label Text="{Binding IsSyncEnabled, Converter={StaticResource BoolToYesNoConverter}, StringFormat='Sync: {0}'}"
                                   FontSize="14"
                                   TextColor="{StaticResource HallowTextPrimary}"/>
                            <Label Text="{Binding SyncStatusText, StringFormat='Last synced: {0}'}"
                                   FontSize="11"
                                   TextColor="{StaticResource HallowTextMuted}"
                                   IsVisible="{Binding IsSyncEnabled}"/>
                        </VerticalStackLayout>
                        
                        <!-- Sync Now Button (only when sync is enabled) -->
                        <Button Grid.Column="1"
                                Text="âŸ³ Sync"
                                Command="{Binding SyncNowCommand}"
                                BackgroundColor="{StaticResource HallowAccentPurple}"
                                TextColor="{StaticResource HallowTextPrimary}"
                                CornerRadius="15"
                                HeightRequest="40"
                                Padding="15,0"
                                WidthRequest="90"
                                IsVisible="{Binding IsSyncEnabled}"
                                IsEnabled="{Binding IsSyncing, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>
                    
                    <!-- Current Sync Code (if enabled) -->
                    <Frame Padding="15"
                           BackgroundColor="{StaticResource HallowCardHover}"
                           BorderColor="{StaticResource HallowAccentPurple}"
                           CornerRadius="15"
                           IsVisible="{Binding IsSyncEnabled}">
                        
                        <VerticalStackLayout Spacing="5" HorizontalOptions="Center">
                            <Label Text="Your Sync Code"
                                   FontSize="12"
                                   TextColor="{StaticResource HallowTextSecondary}"
                                   HorizontalOptions="Center"/>
                            <Label Text="{Binding SyncCode}"
                                   FontSize="22"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource HallowAccentPurple}"
                                   HorizontalOptions="Center"
                                   FontFamily="Consolas"/>
                            <Label Text="Share this with your other devices"
                                   FontSize="10"
                                   TextColor="{StaticResource HallowTextMuted}"
                                   HorizontalOptions="Center"/>
                        </VerticalStackLayout>
                    </Frame>
                    
                    <!-- Setup Buttons (when not enabled) -->
                    <VerticalStackLayout Spacing="10" IsVisible="{Binding IsSyncEnabled, Converter={StaticResource InvertedBoolConverter}}">
                        <Button Text="ðŸ“± Generate Sync Code"
                                Command="{Binding GenerateSyncCodeCommand}"
                                HeightRequest="50"
                                CornerRadius="25"
                                FontAttributes="Bold"
                                TextColor="{StaticResource HallowTextPrimary}"
                                IsEnabled="{Binding IsSyncing, Converter={StaticResource InvertedBoolConverter}}">
                            <Button.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                    <GradientStop Color="{StaticResource HallowAccentPurple}" Offset="0.0" />
                                    <GradientStop Color="{StaticResource HallowRose}" Offset="1.0" />
                                </LinearGradientBrush>
                            </Button.Background>
                        </Button>
                        
                        <Label Text="or"
                               FontSize="12"
                               TextColor="{StaticResource HallowTextMuted}"
                               HorizontalOptions="Center"/>
                        
                        <Button Text="ðŸ”— Link to Another Device"
                                Command="{Binding LinkDeviceCommand}"
                                BackgroundColor="{StaticResource HallowCardHover}"
                                TextColor="{StaticResource HallowTextPrimary}"
                                CornerRadius="20"
                                HeightRequest="45"
                                IsEnabled="{Binding IsSyncing, Converter={StaticResource InvertedBoolConverter}}"/>
                    </VerticalStackLayout>
                    
                    <!-- Remove Sync Button -->
                    <Button Text="Remove Sync"
                            Command="{Binding RemoveSyncCommand}"
                            BackgroundColor="{StaticResource HallowCardHover}"
                            TextColor="{StaticResource HallowTextSecondary}"
                            CornerRadius="15"
                            HeightRequest="40"
                            IsVisible="{Binding IsSyncEnabled}"
                            HorizontalOptions="Start"/>
                    
                    <!-- Syncing Indicator -->
                    <HorizontalStackLayout Spacing="10" 
                                           IsVisible="{Binding IsSyncing}"
                                           HorizontalOptions="Center">
                        <ActivityIndicator IsRunning="True" 
                                          Color="{StaticResource HallowAccentPurple}"
                                          WidthRequest="20" HeightRequest="20"/>
                        <Label Text="{Binding SyncStatusText}"
                               FontSize="13"
                               TextColor="{StaticResource HallowAccentPurple}"/>
                    </HorizontalStackLayout>
                    
                    <Label Text="ðŸ’¡ Tip: Generate a sync code on one device, then link from your other devices using that code."
                           FontSize="11"
                           FontAttributes="Italic"
                           TextColor="{StaticResource HallowTextMuted}"/>
                </VerticalStackLayout>
            </Frame>
            
            <!-- Training Data Section -->
            <Frame Padding="20"
                   BackgroundColor="{StaticResource HallowCardBackground}"
                   BorderColor="Transparent"
                   CornerRadius="20">
                
                <VerticalStackLayout Spacing="15">
                    <Label Text="ðŸ“Š Training Data Statistics"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{StaticResource HallowTextPrimary}"/>
                    
                    <Label Text="Rate AI responses with ðŸ‘/ðŸ‘Ž to help improve future models."
                           FontSize="13"
                           TextColor="{StaticResource HallowTextSecondary}"/>
                    
                    <!-- Stats Grid -->
                    <Frame Padding="15" BackgroundColor="{StaticResource HallowCardHover}"
                           BorderColor="Transparent" CornerRadius="12">
                        <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto" RowSpacing="10">
                            <Label Grid.Row="0" Text="Total Chat Sessions:" TextColor="{StaticResource HallowTextPrimary}"/>
                            <Label Grid.Row="0" Grid.Column="1" Text="{Binding TotalSessions}" FontAttributes="Bold" TextColor="{StaticResource HallowTextPrimary}"/>
                            
                            <Label Grid.Row="1" Text="Total Messages:" TextColor="{StaticResource HallowTextPrimary}"/>
                            <Label Grid.Row="1" Grid.Column="1" Text="{Binding TotalMessages}" FontAttributes="Bold" TextColor="{StaticResource HallowTextPrimary}"/>
                            
                            <Label Grid.Row="2" Text="Rated Messages:" TextColor="{StaticResource HallowTextPrimary}"/>
                            <Label Grid.Row="2" Grid.Column="1" Text="{Binding RatedMessages}" FontAttributes="Bold" TextColor="{StaticResource HallowAccentPurple}"/>
                            
                            <Label Grid.Row="3" Text="ðŸ‘ Positive Ratings:" TextColor="{StaticResource HallowTextPrimary}"/>
                            <Label Grid.Row="3" Grid.Column="1" Text="{Binding PositiveRatings}" FontAttributes="Bold" TextColor="#4CAF50"/>
                            
                            <Label Grid.Row="4" Text="ðŸ‘Ž Negative Ratings:" TextColor="{StaticResource HallowTextPrimary}"/>
                            <Label Grid.Row="4" Grid.Column="1" Text="{Binding NegativeRatings}" FontAttributes="Bold" TextColor="{StaticResource HallowRose}"/>
                            
                            <Label Grid.Row="5" Text="With Feedback:" TextColor="{StaticResource HallowTextPrimary}"/>
                            <Label Grid.Row="5" Grid.Column="1" Text="{Binding MessagesWithFeedback}" FontAttributes="Bold" TextColor="{StaticResource HallowTextPrimary}"/>
                        </Grid>
                    </Frame>
                    
                    <Button Text="ðŸ”„ Refresh Stats"
                            Command="{Binding RefreshStatsCommand}"
                            BackgroundColor="{StaticResource HallowCardHover}"
                            TextColor="{StaticResource HallowTextPrimary}"
                            CornerRadius="20"
                            HeightRequest="44"/>
                </VerticalStackLayout>
            </Frame>
            
            <!-- Export Section -->
            <Frame Padding="20"
                   BackgroundColor="{StaticResource HallowCardBackground}"
                   BorderColor="Transparent"
                   CornerRadius="20">
                
                <VerticalStackLayout Spacing="15">
                    <Label Text="ðŸ“¤ Export Training Data"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{StaticResource HallowTextPrimary}"/>
                    
                    <Label Text="Export rated conversations in JSONL format for LLM fine-tuning."
                           FontSize="13"
                           TextColor="{StaticResource HallowTextSecondary}"/>
                    
                    <Button Text="Export All Rated Conversations"
                            Command="{Binding ExportAllRatedCommand}"
                            HeightRequest="50"
                            CornerRadius="25"
                            TextColor="{StaticResource HallowTextPrimary}"
                            IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}">
                        <Button.Background>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                <GradientStop Color="{StaticResource HallowAccentPurple}" Offset="0.0" />
                                <GradientStop Color="{StaticResource HallowRose}" Offset="1.0" />
                            </LinearGradientBrush>
                        </Button.Background>
                    </Button>
                    
                    <Button Text="Export Positive Only (ðŸ‘)"
                            Command="{Binding ExportPositiveOnlyCommand}"
                            BackgroundColor="#4CAF50"
                            TextColor="White"
                            CornerRadius="25"
                            HeightRequest="50"
                            IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"/>
                    
                    <Label Text="Tip: Export positive ratings for training good responses, or all ratings for DPO training."
                           FontSize="11"
                           FontAttributes="Italic"
                           TextColor="{StaticResource HallowTextMuted}"/>
                </VerticalStackLayout>
            </Frame>
            
            <!-- About Section -->
            <Frame Padding="20"
                   BackgroundColor="{StaticResource HallowCardBackground}"
                   BorderColor="Transparent"
                   CornerRadius="20">
                
                <VerticalStackLayout Spacing="10">
                    <Label Text="â„¹ï¸ About"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{StaticResource HallowTextPrimary}"/>
                    
                    <Label Text="AI Bible App"
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="{StaticResource HallowTextPrimary}"/>
                    
                    <Label Text="Chat with biblical figures, powered by local AI."
                           FontSize="13"
                           TextColor="{StaticResource HallowTextSecondary}"/>
                    
                    <Label Text="Version 1.0"
                           FontSize="12"
                           TextColor="{StaticResource HallowTextMuted}"/>
                </VerticalStackLayout>
            </Frame>
            
            <!-- Activity Indicator -->
            <ActivityIndicator IsRunning="{Binding IsBusy}"
                              IsVisible="{Binding IsBusy}"
                              Color="{StaticResource HallowAccentPurple}"/>
            
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
